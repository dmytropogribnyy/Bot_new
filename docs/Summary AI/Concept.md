Концептуальный документ: Архитектура высокочастотного торгового бота "OptiFlow HFT"
Версия: 2.0
Дата: 1 августа 2025 г.

1. Введение и философия
   "OptiFlow HFT" — это полностью переработанная, высокопроизводительная торговая система, предназначенная для работы на криптовалютных фьючерсных рынках с минимальной задержкой. В отличие от традиционных ботов, работающих на свечных данных, OptiFlow HFT спроектирован для использования микроструктуры рынка и неэффективностей, возникающих в миллисекундном диапазоне.

Ключевые принципы:

Скорость превыше всего: Каждый компонент архитектуры оптимизирован для минимальной задержки.

Надежность и отказоустойчивость: Система спроектирована для работы в режиме 24/7/365 с механизмами самовосстановления.

Модульность и масштабируемость: Архитектура позволяет легко добавлять новые стратегии, рынки и источники данных.

Точность симуляции: Бэктестинг должен максимально точно отражать реальные торговые условия, включая задержки и позицию в очереди ордеров.

2. Архитектура системы
   Система будет построена на асинхронной, событийно-ориентированной архитектуре "Producer-Consumer", как рекомендовано в отчете Gemini. Это позволяет эффективно обрабатывать множество потоков данных без блокировок.

Основные компоненты:

Ядро (main.py, core/async_engine.py):

Запускает и координирует все модули.

Использует asyncio с uvloop для максимальной производительности цикла событий.

Клиент Биржи (core/exchange_client.py):

Единая точка входа для всех взаимодействий с API Binance.

Централизованный Rate Limiter: Реализует алгоритм "Token Bucket" для проактивного управления всеми типами лимитов API (IP weight, orders/10s, orders/min). Включает синхронизацию с реальными лимитами из заголовков ответов сервера (X-MBX-USED-WEIGHT).

WebSocket First: Приоритетное использование WebSocket API для отправки ордеров и получения обновлений аккаунта в реальном времени для минимизации задержек.

Продюсеры данных (в core/exchange_client.py или core/data_producers.py):

Асинхронные задачи, каждая из которых подписывается на один WebSocket-поток (например, aggTrade, depth@100ms, bookTicker).

Их единственная задача — получать данные, парсить их с помощью orjson и немедленно помещать в соответствующие очереди asyncio.Queue.

Консьюмеры / Обработчики (в strategies/ и core/trading_engine.py):

Signal Consumer (strategies/scalping_v1.py): Асинхронно извлекает данные из очередей, реконструирует стакан ордеров, рассчитывает индикаторы (включая OBI) и генерирует торговые сигналы.

Execution Consumer (core/trading_engine.py): Получает сигналы из signal_queue и принимает решение об исполнении, отправляя ордера через ExchangeClient.

Менеджер Рисков (core/risk_manager.py):

Централизованный модуль, отвечающий за все аспекты безопасности.

Контроль количественных правил Binance: Отслеживает Unfilled Ratio (UFR) и GTC Cancel Ratio (GCR) в реальном времени, чтобы избежать торговых ограничений.

Управление размером позиции: Использует вашу адаптивную логику, но с более быстрыми входными данными.

Защитные механизмы: Реализует лимиты на дневную просадку (drawdown), серию убытков и максимальное количество открытых позиций.

3. Стратегия и источники "альфы"
   Система будет использовать гибридный подход, сочетая вашу текущую проверенную логику с новыми HFT-сигналами.

Order Book Imbalance (OBI): Будет рассчитываться в реальном времени и использоваться как ключевой краткосрочный предиктор. Формула: (Bid Volume - Ask Volume) / (Bid Volume + Ask Volume).

Анализ потока сделок (aggTrade): Анализ скорости, объема и направления сделок для определения агрессии покупателей или продавцов.

Ваша текущая логика (MACD/RSI/EMA): Будет использоваться как фильтр среднего и долгосрочного тренда, подтверждая HFT-сигналы.

Оптимизация производительности: Критически важные расчеты индикаторов (RSI, и т.д.) будут оптимизированы с помощью Numba JIT для достижения максимальной скорости.

4. Управление ордерами и исполнение
   Валидация ордеров: Будет использоваться единая функция validate_and_adjust_quantity для предотвращения ошибок MIN_NOTIONAL и других проблем с размером ордера.

Типы ордеров: Приоритет будет отдаваться ордерам LIMIT с флагом postOnly (GTC/GTX) для получения maker-комиссий, как это принято в HFT.

Мониторинг: Вместо периодических запросов REST API, состояние ордеров и позиций будет отслеживаться через пользовательский WebSocket-поток, что обеспечит мгновенные обновления.

5. Инфраструктура и развертывание
   Окружение: Для минимизации сетевых задержек бот должен быть развернут на VPS, расположенном как можно ближе к серверам Binance (например, в Токио).

Оптимизация ОС: Использование настроек TCP, таких как TCP_NODELAY, для уменьшения задержек.

Логирование: Вся информация будет храниться в единой базе данных SQLite (trading_log.db) для быстрого доступа и анализа.

Этот концептуальный документ определяет четкий путь к созданию торгового бота, который не просто автоматизирует вашу стратегию, а является полноценной HFT-системой, способной конкурировать на современных криптовалютных рынках.
