–§–∏–Ω–∞–ª—å–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –∫ —Ç–µ—Å—Ç–æ–≤–æ–º—É –∑–∞–ø—É—Å–∫—É –±–æ—Ç–∞ –∏ –ø–µ—Ä–µ—Ö–æ–¥—É –∫ –ø–æ–ª–Ω–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

1. –û–±–∑–æ—Ä
   –¶–µ–ª—å ‚Äî –ø—Ä–æ–≤–µ—Å—Ç–∏ –ø–µ—Ä–≤—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ (DRY_RUN = False) –≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç —Å –¥–µ–ø–æ–∑–∏—Ç–æ–º 44 USD —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º —Ä–∏—Å–∫–æ–º, –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∞ –∑–∞—Ç–µ–º –ø–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–ª–Ω–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∏—Å–∫–∞–º–∏. –ù–∞ –¥–∞–Ω–Ω–æ–º —ç—Ç–∞–ø–µ –≤–∞–∂–Ω–æ:

–ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∏—Å–∫ –Ω–∞ —Ç–µ—Å—Ç–µ: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å RISK_PERCENT = 0.01 (1% —Ä–∏—Å–∫–∞, —á—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç 0,44 USD –ø—Ä–∏ –¥–µ–ø–æ–∑–∏—Ç–µ 44 USD) –∏ MAX_POSITIONS = 1.

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å DRY_RUN = False –∏ VERBOSE = True –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –∏ –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –∑–∞–º–µ–Ω–∏—Ç—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏–∏ get_adaptive_risk_percent(balance) –∏ get_max_positions(balance).

–£—Å—Ç—Ä–∞–Ω–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ª–∏–Ω—Ç–µ—Ä–∞ (ruff) –≤ utils_core.py, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–º–∏ –∏–º–ø–æ—Ä—Ç–∞–º–∏.

2. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ config.py
   –í–Ω–µ—Å–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è —Ç–µ—Å—Ç–∞:

python
Copy

# config.py

# ... (–ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–¥)

# --- Risk Management ---

AGGRESSIVENESS_THRESHOLD = 0.6
AGGRESSIVE_THRESHOLD = 50
SAFE_THRESHOLD = 10
MIN_NOTIONAL = 5
MAX_HOLD_MINUTES = 90
RISK_DRAWDOWN_THRESHOLD = 5.0

# –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ (15 –º–∏–Ω—É—Ç, –¥–µ–ø–æ–∑–∏—Ç 44 USD)

RISK_PERCENT = 0.01 # 1% —Ä–∏—Å–∫–∞ –Ω–∞ —Å–¥–µ–ª–∫—É (–¥–ª—è —Ç–µ—Å—Ç–∞)
MAX_POSITIONS = 1 # –ú–∞–∫—Å–∏–º—É–º 1 —Å–¥–µ–ª–∫–∞

# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª–Ω–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ (–±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞)

def get_adaptive_risk_percent(balance):
"""–†–∞—Å—á–µ—Ç –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ —Ä–∏—Å–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–ª–∞–Ω—Å–∞."""
if balance < 100:
return 0.01 # 1% –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ < 100
elif balance < 300:
return 0.02 # 2% –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ 100-300
elif balance < 1000:
return 0.03 # 3% –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ 300-1000
else:
return 0.05 # 5% –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ > 1000

def get_max_positions(balance):
"""–†–∞—Å—á–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —á–∏—Å–ª–∞ —Å–¥–µ–ª–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–ª–∞–Ω—Å–∞."""
if balance < 100:
return 1 # 1 —Å–¥–µ–ª–∫–∞ –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ < 100
elif balance < 300:
return 2 # 2 —Å–¥–µ–ª–∫–∏ –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ 100-300
elif balance < 1000:
return 3 # 3 —Å–¥–µ–ª–∫–∏ –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ 300-1000
else:
return 5 # 5 —Å–¥–µ–ª–æ–∫ –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ > 1000

# --- Mode & Debug ---

DRY_RUN = False # –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ
VERBOSE = True # –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
USE_DYNAMIC_IN_DRY_RUN = True
ADAPTIVE_SCORE_ENABLED = True

# ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥)

3. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ utils_core.py
   –ß—Ç–æ–±—ã —É—Å—Ç—Ä–∞–Ω–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ª–∏–Ω—Ç–µ—Ä–∞ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç —Ä–∏—Å–∫–∞, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:

–£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é —Ñ—É–Ω–∫—Ü–∏–∏ get_adaptive_risk_percent –∏–∑ utils_core.py, –∫–æ—Ç–æ—Ä–∞—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ –∂—ë—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.

–û—Ç—Å–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∏–º–ø–æ—Ä—Ç—ã –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É –∏ —É–¥–∞–ª–∏—Ç–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∏–º–ø–æ—Ä—Ç RISK_PERCENT. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ config.py.

–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ –∏–º–ø–æ—Ä—Ç–æ–≤ –∏ —Ñ—É–Ω–∫—Ü–∏—è set_leverage_for_symbols –±—É–¥—É—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:

python
Copy

# utils_core.py

import json
import os
import time
from datetime import datetime
from threading import Lock

from config import exchange, get_adaptive_risk_percent, LEVERAGE_MAP, SYMBOLS_ACTIVE
from utils_logging import log

# –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ —Ñ–∞–π–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞–±–æ—Ç–∞ —Å –∫–µ—à–µ–º, –∑–∞–≥—Ä—É–∑–∫–∞/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ —Ç.–¥.)

def set_leverage_for_symbols():
for symbol in SYMBOLS_ACTIVE:
leverage = LEVERAGE_MAP.get(symbol, 5)
safe_call_retry(
exchange.set_leverage,
leverage,
symbol,
tries=3,
delay=1,
label=f"set_leverage {symbol}",
)
log("Leverage set for all symbols", level="INFO")
–ü–æ—Å–ª–µ —ç—Ç–∏—Ö –ø—Ä–∞–≤–æ–∫ –ª–∏–Ω—Ç–µ—Ä –Ω–µ –±—É–¥–µ—Ç –≤—ã–¥–∞–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–º–ø–æ—Ä—Ç–∞—Ö.

4. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ symbol_processor.py
   –í —Ñ–∞–π–ª–µ symbol_processor.py –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ MAX_POSITIONS (–¥–ª—è —Ç–µ—Å—Ç–∞) –∏–∑ config.py, –∞ —Ç–∞–∫–∂–µ –æ—Å—Ç–∞–≤–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ get_adaptive_risk_percent(balance) –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Ä–∏—Å–∫–∞:

python
Copy

# symbol_processor.py

from config import DRY_RUN, MIN_NOTIONAL, SL_PERCENT, MAX_POSITIONS
from core.order_utils import calculate_order_quantity
from core.strategy import fetch_data, should_enter_trade
from core.trade_engine import (
dry_run_positions_count,
get_position_size,
open_positions_count,
open_positions_lock,
)
from utils_core import get_adaptive_risk_percent, get_cached_balance
from utils_logging import log

def process_symbol(symbol, balance, last_trade_times, lock):
try:
with open_positions_lock:
active_count = dry_run_positions_count if DRY_RUN else open_positions_count
if active_count >= MAX_POSITIONS:
log(
f"‚è© Skipping {symbol} ‚Äî max open positions ({MAX_POSITIONS}) reached",
level="DEBUG",
)
return None

        if get_position_size(symbol) > 0:
            log(f"‚è© Skipping {symbol} ‚Äî already in position", level="DEBUG")
            return None

        df = fetch_data(symbol)
        if df is None:
            log(f"‚ö†Ô∏è Skipping {symbol} ‚Äî fetch_data returned None", level="WARNING")
            return None

        result = should_enter_trade(symbol, df, None, last_trade_times, lock)
        if result is None:
            log(f"‚ùå No signal for {symbol}", level="DEBUG")
            return None

        direction, score, is_reentry = result
        entry = df["close"].iloc[-1]
        stop = entry * (1 - SL_PERCENT) if direction == "buy" else entry * (1 + SL_PERCENT)
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é get_adaptive_risk_percent –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∏—Å–∫–∞
        risk_percent = get_adaptive_risk_percent(balance)
        qty = calculate_order_quantity(entry, stop, balance, risk_percent)

        if qty * entry < MIN_NOTIONAL:
            log(f"‚ö†Ô∏è Notional too low for {symbol} ‚Äî skipping", level="WARNING")
            return None

        log(
            f"{symbol} üîç Calculated qty: {qty:.3f}, entry: {entry:.2f}, notional: {qty * entry:.2f}",
            level="DEBUG",
        )

        return {
            "symbol": symbol,
            "direction": direction,
            "qty": qty,
            "entry": entry,
            "score": score,
            "is_reentry": is_reentry,
        }
    except Exception as e:
        log(f"üî• Error in process_symbol for {symbol}: {e}", level="ERROR")
        return None

5. –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
   –ü–µ—Ä–µ–¥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º:

–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –∫–æ–¥–∞ –∏ —Å–¥–µ–ª–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ data/tp_performance.csv, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –≤ —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º.

–ò–∑–º–µ–Ω–∏—Ç–µ SYMBOLS_ACTIVE –≤ config.py, –æ—Å—Ç–∞–≤–∏–≤ —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –ø–∞—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, BTC/USDC, ETH/USDC) –¥–ª—è —Ç–µ—Å—Ç–∞.

–ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ (DRY_RUN = False) –Ω–∞ 15 –º–∏–Ω—É—Ç:

–°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ (telegram_log.txt) –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –≤ Telegram.

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞—Å—á—ë—Ç–∞ –æ–±—ä—ë–º–∞ —Å–¥–µ–ª–∫–∏ (qty), –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–ª–µ—á–∞ (¬´Leverage set for all symbols¬ª) –∏ —Ä–∞–±–æ—Ç—É –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ –≤—Ö–æ–¥–∞/–≤—ã—Ö–æ–¥–∞ (TP1, SL, Breakeven, Trailing Stop).

6. –î–∞–ª—å–Ω–µ–π—à–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞
   –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞:

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ª–æ–≥–∏, —Ñ–∞–π–ª—ã tp_performance.csv –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Telegram.

–ü—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã –∑–∞–º–µ–Ω–∏—Ç–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (RISK_PERCENT –∏ MAX_POSITIONS) –Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç —Å –ø–æ–º–æ—â—å—é —Ñ—É–Ω–∫—Ü–∏–π get_adaptive_risk_percent(balance) –∏ get_max_positions(balance). –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –±–æ—Ç—É –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—é –±–∞–ª–∞–Ω—Å–∞ –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞.

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –≤–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã: –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∏—Å–∫–∞ –Ω–∞ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –∫–æ–¥–∞ –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –ª–∏–Ω—Ç–µ—Ä–∞ –∏ –¥–∞–ª—å–Ω–µ–π—à–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ –ø–æ–ª–Ω–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏. –ï—Å–ª–∏ –≤—Å—ë —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º, –º–æ–∂–Ω–æ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –∑–∞–ø—É—Å–∫—É —Ç–µ—Å—Ç–∞.
