Взаимосвязи модулей проекта

1. Main Flow (Основной поток)
   main.py
   Является точкой входа в систему. Этот модуль инициирует запуск всех ключевых процессов:

Запускает Engine Controller для управления торговым циклом.

Инициализирует Pair Selector для динамического формирования списка активных пар.

Запускает IP Monitor, который отслеживает изменения внешнего IP и уведомляет о необходимости обновления API-правил.

Запускает обработку Telegram-команд через Telegram Handler & Commands.

Инициализирует циклы отчётов и оптимизации (Report & Optimizer Loops).

2. Торговый блок
   2.1 Engine Controller
   Engine Controller (из engine_controller.py) является связующим звеном между стратегией и движком торговли.

Он получает сигналы от Strategy и передаёт их в Trade Engine для исполнения.

Проверяет глобальные параметры, такие как баланс и число открытых позиций, и управляет логикой Smart Switch (закрытие старой позиции при улучшении сигнала).

2.2 Strategy
Strategy (из strategy.py) отвечает за оценку рыночных данных и принятие решения о входе в сделку.

Для оценки сигнала она использует:

Score Evaluator (из score_evaluator.py), который рассчитывает итоговый score по ряду технических индикаторов.

Volatility Controller (из volatility_controller.py), определяющий дополнительные фильтры на основе волатильности.

Логика Smart Re-entry и повторного входа реализована именно здесь: если новый сигнал существенно лучше предыдущего (с учетом cooldown), стратегия генерирует сигнал ре-ентри.

2.3 Trade Engine
Trade Engine (из trade_engine.py) непосредственно управляет исполнением ордеров.

Основные функции:

Вычисление параметров сделок (размер позиции, уровни TP/SL) с учетом автоматической настройки TP/SL (Auto TP/SL Logic).

Выполнение ордеров (лимитные ордера для тейк-профитов, стоп-ордера для стоп-лосса) через API биржи.

Запуск вспомогательных процессов для сопровождения сделки (trailing stop, break-even, soft exit).

Для сохранения сведений о текущих сделках используется TradeInfoManager – потокобезопасный класс, который хранит данные о сделках, такие как score, время входа и закрытия, а также флаги (tp1_hit, soft_exit_hit и т.д.).

При закрытии сделки вызывается функция записи результата – через TP Logger и Entry Logger создаются записи для последующего анализа и формирования статистики.

3. Отчетность и оптимизация
   Stats & Daily/Weekly Reports (из stats.py):
   Формируют отчёты по ключевым метрикам, таким как общее число сделок, винрейт, суммарный PnL, депозиты и выводы. Эти данные берутся из логов сделок и глобального словаря статистики.

Score Heatmap (из score_heatmap.py):
Генерирует графическую визуализацию (heatmap) по истории оценок сигналов для оценки эффективности стратегии за заданный период.

TP Optimizer / TP Optimizer ML (из tp_optimizer.py и tp_optimizer_ml.py):
Модули, анализирующие историю сделок (файл tp_performance.csv) для автоматической корректировки значений тейк-профитов и фильтров. Они обновляют параметры конфигурации, если показатели сделок изменились, и отправляют отчёты через Telegram.

4. Коммуникации (Telegram)
   Telegram Handler & Commands (из telegram_handler.py и telegram_commands.py):
   Обрабатывают входящие команды от пользователя (например, /pause, /stop, /shutdown), отправляют сообщения об ошибках и уведомления о событиях.

Telegram Utils (из telegram_utils.py):
Отвечают за отправку сообщений и файлов в Telegram, включая экранирование Markdown (функция escape_markdown_v2).

5. Конфигурация и утилиты
   config.py:
   Хранит все настройки проекта — параметры TP/SL, рисковые коэффициенты, параметры DRY_RUN/REAL_RUN и многие другие константы, используемые во всех модулях.

utils_core.py:
Содержит вспомогательные функции, такие как safe_call_retry (для устойчивых вызовов к API), функции работы с состоянием бота (load_state, save_state) и кеширование баланса/позиций.

utils_logging.py:
Отвечает за ведение лог-файлов, цветной вывод сообщений в консоль и резервное копирование/восстановление конфигурационных файлов.

Диаграмма взаимодействия (Mermaid)
Ниже приведена диаграмма в формате Mermaid, которая наглядно иллюстрирует основные взаимосвязи:

flowchart TD
subgraph Main Flow
A[main.py] -->|Инициирует| B(Engine Controller)
A --> C(Pair Selector)
A --> D(IP Monitor)
A --> E(Telegram Handler & Commands)
A --> F(Report & Optimizer Loops)
end

    subgraph Trading Engine
        B --> G(Strategy)
        B --> H(Trade Engine)
        G --> I(Score Evaluator)
        G --> J(Volatility Controller)
        H --> K(TradeInfoManager)
        H --> L(Entry Logger)
        H --> M(TP Logger)
        H --> N(Auto TP/SL Logic)
    end

    subgraph Reporting & Optimization
        F --> O(Stats & Daily/Weekly Reports)
        F --> P(Score Heatmap)
        F --> Q(TP Optimizer / TP Optimizer ML)
    end

    subgraph Communication
        E --> R(Telegram Utils)
    end

    subgraph Configurations
        S[config.py]
    end

    %% Связи с конфигурационным файлом
    G --- S
    H --- S
    I --- S
    J --- S
    N --- S
    R --- S
    O --- S
    Q --- S

---

Заключение
Система имеет хорошо продуманную модульную архитектуру. Основной поток в main.py объединяет торговый движок, стратегию и процессы отчетности, а также обеспечивает интеграцию с Telegram для уведомлений и команд. Торговый блок включает логику Smart Re-entry, Soft Exit и Auto TP/SL, что подтверждено подробным анализом кода. Конфигурационные файлы и вспомогательные утилиты делают систему устойчивой при работе как в тестовом, так и в реальном режимах.

Эту схему и описание можно сохранить как руководство по архитектуре проекта, чтобы новые разработчики быстрее освоились и понимали ключевые взаимосвязи модулей.
